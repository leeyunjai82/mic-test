<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB Serial 통신</title>
</head>
<body>
    <h1>USB Serial 통신</h1>
    <button id="connectButton">연결</button>
    <button id="sendButton" disabled>전송</button>
    <div>
        <textarea id="receivedText" rows="5" cols="50" placeholder="수신된 메시지"></textarea>
    </div>
    <div>
        <input type="text" id="sendText" placeholder="전송할 메시지">
    </div>

    <script>
        let device;
        let inputEndpoint;
        let outputEndpoint;
        let receivedText = document.getElementById('receivedText');
        let sendButton = document.getElementById('sendButton');
        let sendText = document.getElementById('sendText');

        async function connect() {
            try {
                device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x1A86, productId: 0x7523 }] });
                await device.open();
                await device.selectConfiguration(1);

                const [interface] = device.configuration.interfaces;
                await interface.claimInterface(interface.interfaceNumber);

                inputEndpoint = interface.endpointIn;
                outputEndpoint = interface.endpointOut;

                sendButton.disabled = false;

                listen();
            } catch (error) {
                console.error('연결 실패:', error);
            }
        }

        async function sendMessage(message) {
            if (!outputEndpoint) return;
            await device.transferOut(outputEndpoint.endpointNumber, new TextEncoder().encode(message));
        }

        async function listen() {
            while (true) {
                let result = await device.transferIn(inputEndpoint.endpointNumber, 64);
                let text = new TextDecoder().decode(result.data);
                receivedText.value = text;
            }
        }

        connectButton.addEventListener('click', async () => {
            try {
                await navigator.usb.requestDevice({ filters: [{ vendorId: 0xVendor_ID, productId: 0xProduct_ID }] });
                connect();
            } catch (error) {
                console.error('USB 장치에 연결 권한이 없습니다.');
            }
        });

        sendButton.addEventListener('click', () => {
            let message = sendText.value.trim();
            if (message) {
                sendMessage(message);
                sendText.value = '';
            }
        });
    </script>
</body>
</html>
